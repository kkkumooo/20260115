<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èª²å ‚å³æ™‚æŠ•ç¥¨ç³»çµ±</title>
    <style>
        body { font-family: 'å¾®è»Ÿæ­£é»‘é«”', sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; background-color: #f4f4f9; }
        .container { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #333; }
        
        /* è€å¸«æ§åˆ¶å€ */
        .admin-panel { border-bottom: 2px dashed #ddd; padding-bottom: 20px; margin-bottom: 20px; }
        input[type="text"] { width: 70%; padding: 10px; font-size: 16px; }
        button.reset-btn { background-color: #ff4d4d; color: white; border: none; padding: 10px 15px; cursor: pointer; border-radius: 5px; }
        
        /* æŠ•ç¥¨å€ */
        .options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .vote-btn { 
            padding: 20px; font-size: 20px; border: none; border-radius: 8px; 
            cursor: pointer; transition: transform 0.1s; color: white;
            font-weight: bold;
        }
        .vote-btn:active { transform: scale(0.95); }
        .btn-a { background-color: #3498db; }
        .btn-b { background-color: #e74c3c; }
        .btn-c { background-color: #f1c40f; color: black; }
        .btn-d { background-color: #2ecc71; }

        /* çµæœé¡¯ç¤ºå€ */
        .result-bar-container { margin-bottom: 10px; }
        .label { font-weight: bold; display: flex; justify-content: space-between; }
        .progress-bg { background-color: #e0e0e0; height: 20px; border-radius: 10px; overflow: hidden; margin-top: 5px; }
        .progress-fill { height: 100%; width: 0%; transition: width 0.5s ease-in-out; }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ™‹â€â™‚ï¸ å³æ™‚æŠ•ç¥¨</h1>

    <!-- è€å¸«è¨­å®šé¡Œç›®å€ -->
    <div class="admin-panel">
        <label>é¡Œç›®ï¼š</label>
        <input type="text" id="questionInput" placeholder="è¼¸å…¥å•é¡Œå¾ŒæŒ‰æ›´æ–°...">
        <button onclick="updateQuestion()">æ›´æ–°é¡Œç›®</button>
        <button class="reset-btn" onclick="resetVotes()">é‡ç½®æŠ•ç¥¨</button>
    </div>

    <!-- é¡Œç›®é¡¯ç¤º -->
    <h2 id="displayQuestion">ç­‰å¾…é¡Œç›®ä¸­...</h2>

    <!-- å­¸ç”ŸæŠ•ç¥¨æŒ‰éˆ• -->
    <div class="options-grid">
        <button class="vote-btn btn-a" onclick="vote('A')">A</button>
        <button class="vote-btn btn-b" onclick="vote('B')">B</button>
        <button class="vote-btn btn-c" onclick="vote('C')">C</button>
        <button class="vote-btn btn-d" onclick="vote('D')">D</button>
    </div>

    <!-- çµæœé¡¯ç¤º -->
    <h3>ğŸ“Š æŠ•ç¥¨çµæœï¼š(<span id="totalVotes">0</span> äººæŠ•ç¥¨)</h3>
    <div id="resultsArea">
        <!-- çµæœæ¢å°‡ç”± JS ç”Ÿæˆ -->
    </div>
</div>

<!-- å¼•å…¥ Firebase SDK -->
<script type="module">
    // 1. å¼•å…¥ Firebase å¿…è¦æ¨¡çµ„
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getDatabase, ref, onValue, set, runTransaction } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

    // ğŸ”´ 2. è«‹å°‡ä½ çš„ firebaseConfig è²¼åœ¨é€™è£¡ (å–ä»£ä¸‹æ–¹çš„å‡è³‡æ–™)
    const firebaseConfig = {
        apiKey: "ä½ çš„API_KEY",
        authDomain: "ä½ çš„å°ˆæ¡ˆID.firebaseapp.com",
        databaseURL: "https://ä½ çš„å°ˆæ¡ˆID-default-rtdb.firebaseio.com",
        projectId: "ä½ çš„å°ˆæ¡ˆID",
        storageBucket: "ä½ çš„å°ˆæ¡ˆID.appspot.com",
        messagingSenderId: "123456789",
        appId: "1:123456789:web:xxxxxx"
    };

    // 3. åˆå§‹åŒ– Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const voteRef = ref(db, 'classroom_vote');

    // 4. ç›£è½è³‡æ–™åº«è®Šå‹• (Real-time æ ¸å¿ƒ)
    onValue(voteRef, (snapshot) => {
        const data = snapshot.val();
        
        if (!data) {
            // å¦‚æœè³‡æ–™åº«æ˜¯ç©ºçš„ï¼Œåˆå§‹åŒ–å®ƒ
            resetVotes(); 
            return;
        }

        // æ›´æ–°ä»‹é¢
        document.getElementById('questionInput').value = data.question;
        document.getElementById('displayQuestion').innerText = data.question;
        
        // è¨ˆç®—ç¸½ç¥¨æ•¸
        const total = (data.counts.A || 0) + (data.counts.B || 0) + (data.counts.C || 0) + (data.counts.D || 0);
        document.getElementById('totalVotes').innerText = total;

        // æ›´æ–°åœ–è¡¨
        updateChart('A', data.counts.A || 0, total, '#3498db');
        updateChart('B', data.counts.B || 0, total, '#e74c3c');
        updateChart('C', data.counts.C || 0, total, '#f1c40f');
        updateChart('D', data.counts.D || 0, total, '#2ecc71');
    });

    // è¼”åŠ©å‡½å¼ï¼šæ›´æ–°å–®ä¸€æ¢åœ–è¡¨
    function updateChart(option, count, total, color) {
        let percentage = total === 0 ? 0 : Math.round((count / total) * 100);
        
        // ç¢ºä¿ HTML çµæ§‹å­˜åœ¨
        let container = document.getElementById(`res-${option}`);
        if(!container) {
            document.getElementById('resultsArea').innerHTML += `
                <div class="result-bar-container">
                    <div class="label"><span>é¸é … ${option}</span> <span id="txt-${option}">0ç¥¨ (0%)</span></div>
                    <div class="progress-bg">
                        <div id="bar-${option}" class="progress-fill" style="background-color: ${color};"></div>
                    </div>
                </div>`;
        }

        // æ›´æ–°æ•¸å€¼èˆ‡å¯¬åº¦
        document.getElementById(`txt-${option}`).innerText = `${count} ç¥¨ (${percentage}%)`;
        document.getElementById(`bar-${option}`).style.width = `${percentage}%`;
    }

    // 5. å…¨åŸŸåŠŸèƒ½ (è®“ HTML æŒ‰éˆ•å¯ä»¥å‘¼å« module å…§çš„å‡½å¼)
    window.vote = function(option) {
        const optionRef = ref(db, `classroom_vote/counts/${option}`);
        // ä½¿ç”¨ Transaction ç¢ºä¿å¤šäººåŒæ™‚é»æ“Šä¸æœƒç®—éŒ¯
        runTransaction(optionRef, (currentCount) => {
            return (currentCount || 0) + 1;
        });
    };

    window.updateQuestion = function() {
        const newQ = document.getElementById('questionInput').value;
        set(ref(db, 'classroom_vote/question'), newQ);
    };

    window.resetVotes = function() {
        if(confirm('ç¢ºå®šè¦æ­¸é›¶æ‰€æœ‰ç¥¨æ•¸å—ï¼Ÿ')) {
            set(voteRef, {
                question: document.getElementById('questionInput').value || "è«‹æº–å‚™é–‹å§‹æŠ•ç¥¨",
                counts: { A: 0, B: 0, C: 0, D: 0 }
            });
        }
    };
</script>

</body>
</html>
